#!/bin/sh
# Init parallel tweak for sysvinit
# 12.12.2019
# 27.02.2020 compress logs
# 07.07.2020 /proc/uptime in log

# Settings
config_dir='/usr/local/etc/init-parallel.d'
log_dir='/tmp/.init-parallel'

# Compress logs
if [ "$1" = 'compress' ] && [ -e ${log_dir} ]; then
	sleep 600 # Long wait for end
	tar cf - -C ${log_dir} . | gzip > ${log_dir}.tar.gz
	rm -r -f ${log_dir}
	exit 0
fi

# Confirm
[ "${runlevel}" = '' ] && exit 1
PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Do!
[ -e ${log_dir} ] || mkdir ${log_dir}
[ -e "${log_dir}/rc${runlevel}.d" ] || mkdir "${log_dir}/rc${runlevel}.d"

[ -e ${config_dir}/rc${runlevel}.d ] && \
[ ! "$(ls ${config_dir}/rc${runlevel}.d)" = '' ] && \
	for daemon in ${config_dir}/rc${runlevel}.d/S*; do
		echo "[$(cat /proc/uptime | awk '{print $1}')] Starting rc${runlevel}.d $(basename ${daemon})" >> ${log_dir}/init-parallel.log 2>&1
		LOG="${log_dir}/rc${runlevel}.d/$(basename ${daemon}).log"
		${daemon} start > ${LOG} 2>&1 &
	done

exit 0
