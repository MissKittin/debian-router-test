#!/bin/sh
# Init parallel tweak for sysvinit - for rc0.d and rc6.d
# 13.01.2021 initial version
# 06.06.2023 deploy

# Settings
config_dir='/usr/local/etc/init-parallel'

# Confirm
[ "${runlevel}" = '' ] && exit 1
PATH='/sbin:/bin:/usr/sbin:/usr/bin'

# Do!
if [ -d '/init-parallel-shutdown.log' ]; then
	print_S1() { echo -n "${1}"; }
	read_file() { while IFS= read -r line || [ -n "${line}" ]; do echo "${line}"; done < "${1}"; }

	log_dir="/init-parallel-shutdown.$(date '+%Y%m%d%H%M%S').log"
	mv '/init-parallel-shutdown.log' "${log_dir}"
	echo "[$(print_S1 $(read_file '/proc/uptime'))] start" >> "${log_dir}/init-parallel-shutdown.time.log"

	for daemon in ${config_dir}/rc${runlevel}.d/K*; do
		[ "${daemon}" = "${config_dir}/rc${runlevel}.d/K*" ] && break
	
		LOG="${log_dir}/$(basename ${daemon}).log"
		"${daemon}" 'stop' > "${LOG}" 2>&1 &
	done
else
	log_dir=''
	for daemon in ${config_dir}/rc${runlevel}.d/K*; do
		[ "${daemon}" = "${config_dir}/rc${runlevel}.d/K*" ] && break
		"${daemon}" 'stop' &
	done
fi
wait

[ ! "${log_dir}" = '' ] && [ -e "${log_dir}/init-parallel-shutdown.time.log" ] && \
	echo "[$(print_S1 $(read_file '/proc/uptime'))] end" >> "${log_dir}/init-parallel-shutdown.time.log"

exit 0
